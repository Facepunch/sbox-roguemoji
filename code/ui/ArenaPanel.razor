@using System;
@using Sandbox;
@using Sandbox.UI;

@inherits GridPanel;
@namespace Interfacer

<style>
    .arena_panel
    {
        overflow: hidden;
    }

    .grid_bg 
    {
        opacity: 0.04;
        position:absolute;
        pointer-events:all;
        background-repeat: repeat;
        //background-position: -73px -73px;
        background-size: 80px;
        border-radius:3px;
        width:100%;
        height:100%;
    }
</style>

<root class="arena_panel">
    <div class="grid_bg" style="background-image: url( textures/bg_tile2.png );" @ref=GridBg></div>
    
    @if(InterfacerGame.Instance.ArenaGridManager?.Things == null)
    {
        return;
    }

    @foreach(Thing thing in GetThings())
    {
        var player = InterfacerGame.Instance.LocalPlayer;
        if(player.IsGridPosVisible(thing.GridPos))
        {
            var offsetGridPos = thing.GridPos - player.CameraGridOffset;
            var index = GetIndex(offsetGridPos);
            <GridCell style="left: @((offsetGridPos.x * 40) + player.CameraPixelOffset.x); top: @((offsetGridPos.y * 40) + player.CameraPixelOffset.y);" Thing=@thing GridIndex=@index @onmouseover=@(() => HoveredCellIndex = index )) />    
        }
    }
</root>

@code
{
    public Panel GridBg { get; protected set; }

    public override int GridWidth => InterfacerGame.ArenaWidth;
    public override int GridHeight => InterfacerGame.ArenaHeight;

    public override void Tick()
    {
        base.Tick();


        //var offset = -36f + MathF.Sin(Time.Now) * 36f;
        //GridBg.Style.Set($"background-position: {offset}px {offset}px;");
    }

    protected override IList<Thing> GetThings()
    {
        return InterfacerGame.Instance.ArenaGridManager?.Things ?? new List<Thing>();
    }

    protected override void OnMouseDown(MousePanelEvent e)
    {
        base.OnMouseDown(e);

        var player = InterfacerGame.Instance.LocalPlayer;
        Hud.Instance.GridCellClickedArena(GetGridPos(MousePosition) + player.CameraGridOffset, rightClick: e.Button == "mouseright", shift: Input.Down(InputButton.Run));
    }

    protected override int BuildHash()
    {
        var player = InterfacerGame.Instance.LocalPlayer;
        return HashCode.Combine(GetThings().Count, player.CameraGridOffset, player.CameraPixelOffset);
    }

    protected override void OnAfterTreeRender(bool firstTime)
    {
        base.OnAfterTreeRender(firstTime);

        var player = InterfacerGame.Instance.LocalPlayer;
        //Log.Info("IsOdd: " + IsOdd(player.GridPos));
        //Log.Info("player.CameraPixelOffset: " + player.CameraPixelOffset + " , " + player.DisplayName);

        //GridBg.Style.Set($"background-position: {-73f + player.CameraPixelOffset.x * 0.9f}px {-73f + player.CameraPixelOffset.y * 0.9f}px;");
        //GridBg.Style.Set($"background-position: {(player.CameraGridOffset.x % 2 == 0 ? -36f : -73f) + player.CameraPixelOffset.x * 0.9f}px {(player.CameraGridOffset.y % 2 == 0 ? -36f : -73f) + player.CameraPixelOffset.y * 0.9f}px;");
        GridBg.Style.Set($"background-position: {((player.CameraGridOffset.x % 2 == 0 ? -40f : -80f) + player.CameraPixelOffset.x * 0.9f) * ScaleToScreen}px {((player.CameraGridOffset.y % 2 == 0 ? -40f : -80f) + player.CameraPixelOffset.y * 0.9f) * ScaleToScreen}px;");

        //GridBg.Style.Set($"background-position: {(IsOdd(player.GridPos) ? -109f : -73f) + player.CameraPixelOffset.x * 0.9f}px {(IsOdd(player.GridPos) ? -109f : -73f) + player.CameraPixelOffset.y * 0.9f}px;");
        //GridBg.Style.Set($"background-position: {player.CameraPixelOffset.x * 0.9f}px {player.CameraPixelOffset.y * 0.9f}px;");
    }

    bool IsOdd(IntVector gridPos)
    {
        return gridPos.x % 2 == gridPos.y % 2;
    }
}