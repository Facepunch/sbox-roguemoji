@using Sandbox;
@using Sandbox.UI;
@using System;

@inherits Panel;
@namespace Interfacer

<style>
    .nearby_icon
    {
        pointer-events:all;
        font-size: 29px;
        flex-shrink: 0;
        border: 1px solid #00000000;
        justify-content:center;
    }

    .nearby_selected 
    {
        border: 1px solid #bbbbff44;
        border-radius:3px;
    }

    .dragging
    {
        opacity: 0.2;
        transition: opacity 0.4s ease-in;
    }

    .player-1 { text-stroke-color: #3333ff; text-stroke-width: 4px; }
    .player-2 { text-stroke-color: #ff0000; text-stroke-width: 4px; }
    .player-3 { text-stroke-color: #009900; text-stroke-width: 4px; }
    .player-4 { text-stroke-color: #ff00ff; text-stroke-width: 4px; }
    .player-5 { text-stroke-color: #ffff00; text-stroke-width: 4px; }
    .player-6 { text-stroke-color: #2299ff; text-stroke-width: 4px; }
    .player-7 { text-stroke-color: #8800bb; text-stroke-width: 4px; }
    .player-8 { text-stroke-color: #ff8800; text-stroke-width: 4px; }
</style>

<root class="nearby_icon @GetSelectedClass()">
    <div class="@GetPlayerClass() @GetDraggingClass()" @ref=IconPanel>@Thing.DisplayIcon</div>
</root>

@code
{
    public Panel IconPanel { get; set; }
    public Thing Thing { get; set; }

    string GetPlayerClass()
    {
        return Thing.PlayerNum > 0 ? $"player-{Thing.PlayerNum}" : "";
    }

    string GetSelectedClass()
    {
        return IsSelected() ? "nearby_selected" : "";
    }

    string GetDraggingClass()
    {
        return Thing == Hud.Instance.DraggedThing ? "dragging" : "";
    }

    bool IsSelected()
    {
        return Thing == InterfacerGame.Instance.LocalPlayer?.SelectedThing;
    }

    protected override Panel CreateTooltipPanel()
    {
        var panel = Hud.Instance.AddChild<CellTooltip>();
        panel.Text = Tooltip;
        panel.AddClass($"player-{Thing.PlayerNum}");
        return panel;
    }

    protected override int BuildHash()
    {
        if (Thing == null)
            return base.BuildHash();

        return HashCode.Combine(Thing.GetNearbyCellHash(), IsSelected());
    }

    protected override void OnAfterTreeRender(bool firstTime)
    {
        base.OnAfterTreeRender(firstTime);

        //if (firstTime)
        //    AddEventListener("onmouseup", StopDragging);

        if (Thing == null)
            return;

        Tooltip = Thing.Tooltip;
    }

    protected override void OnMouseDown(MousePanelEvent e)
    {
        base.OnMouseDown(e);

        bool shift = Input.Down(InputButton.Run);
        if(shift)
            InterfacerGame.NearbyThingClickedCmd(Thing.NetworkIdent, rightClick: e.Button == "mouseright", shift);
        else
            Hud.Instance.StartDragging(Thing, this);
        
        //Log.Info("NearbyCell:OnMouseDown: " + Thing.GridPos);
    }

    protected override void OnMouseUp(MousePanelEvent e)
    {
        base.OnMouseDown(e);
        InterfacerGame.NearbyThingClickedCmd(Thing.NetworkIdent, rightClick: e.Button == "mouseright", shift: Input.Down(InputButton.Run));
        Log.Info("NearbyCell:OnMouseUp: " + Thing.GridPos);
    }

    void DrawDebugText(string text)
    {
        DebugOverlay.ScreenText(text, PanelPositionToScreenPosition(Vector2.Zero), 0, Color.White, 0f);
    }

    //private void StopDragging(PanelEvent e)
    //{
    //    Log.Info("NearbyCell:StopDragging: " + Thing.GridPos);
    //}
}